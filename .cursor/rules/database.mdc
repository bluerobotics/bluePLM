---
description: Database schema and Supabase patterns
globs:
  - supabase/**/*.sql
  - src/lib/schemaVersion.ts
  - src/types/database.ts
---

# Database Schema Rules

## Change Protocol (All 3 Steps Required)

1. `supabase/schema.sql` ← source of truth, bump version
2. `src/lib/schemaVersion.ts` ← sync EXPECTED_SCHEMA_VERSION
3. `src/types/database.ts` ← regenerate if schema changed

## Supabase Query Patterns

```typescript
// GOOD: explicit columns, error handling
const { data, error } = await supabase
  .from('files')
  .select('id, name, status')
  .range(0, 49);
if (error) throw error;

// BAD: select(*), no error check
const { data } = await supabase.from('files').select('*');
```

## Storage

- Private files: signed URLs only
- Public assets: direct URLs OK

## Migration Naming

`YYYYMMDD-description.sql` → e.g., `20240115-add-workflow-status.sql`
